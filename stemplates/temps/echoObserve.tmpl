package observe

import (
	"context"
	"fmt"
    "strconv"
	"strings"
	"time"


	"{{.ProjectName}}/configs"
	"go.opentelemetry.io/otel"
	//"github.com/google/uuid"
	"github.com/labstack/echo/v4"
	//"go.opentelemetry.io/otel/attribute"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
	//"go.opentelemetry.io/otel/propagation"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.4.0"
	oteltrace "go.opentelemetry.io/otel/trace"
)

func NewAppTracer(cfg *configs.EnvConfig) oteltrace.Tracer {
	return otel.Tracer(fmt.Sprintf("cli-server-%v", cfg.GetOrDefault("APP_NAME", "blue-app")))
}

func InitTracer(cfg *configs.EnvConfig) *sdktrace.TracerProvider {
	traceExporter := cfg.Get("TRACE_EXPORTER")
	tracerHost := cfg.Get("TRACER_HOST")
	tracerPort := cfg.GetOrDefault("TRACER_PORT", "4317") // Default to gRPC port

	// Create resource with service name
	res := resource.NewWithAttributes(
		semconv.SchemaURL,
		semconv.ServiceNameKey.String(cfg.Get("APP_NAME")),
	)

	// Use TraceIDRatioBased for random sampling (10% here) if env not set

	sampleSize, _ := strconv.ParseFloat(cfg.GetOrDefault("TRACER_SAMPLE", "0.01"), 64)
	sampler := sdktrace.ParentBased(sdktrace.TraceIDRatioBased(sampleSize))

	tp := sdktrace.NewTracerProvider(
		sdktrace.WithResource(res),
		sdktrace.WithSampler(sampler),
		// FIX: Add resource detection to avoid repeated lookup
	)

	if strings.ToLower(traceExporter) == "jaeger" && tracerHost != "" {
		exporter, err := otlptracegrpc.New(context.Background(),
			otlptracegrpc.WithInsecure(),
			otlptracegrpc.WithEndpoint(tracerHost+":"+tracerPort), // Use simple concatenation
			otlptracegrpc.WithReconnectionPeriod(5 * time.Second),
		)
		if err == nil {
			// FIX: Increase BatchSpanProcessor limits for high throughput
			batcher := sdktrace.NewBatchSpanProcessor(exporter,
				sdktrace.WithMaxQueueSize(30000),      // Increased from 10k
				sdktrace.WithMaxExportBatchSize(2048), // Increased from 512
				sdktrace.WithBatchTimeout(5*time.Second),
			)
			tp.RegisterSpanProcessor(batcher)
		}
	}

	return tp
}

func EchoAppSpanner(ctx echo.Context, spanName string, appTracer oteltrace.Tracer) (context.Context, oteltrace.Span) {

	return appTracer.Start(ctx.Request().Context(), spanName)
}

type RouteTracer struct {
	Tracer context.Context
	Span   oteltrace.Span
}
