package utils

import (
	"fmt"
	"hash/fnv"
	"net"
	"os"

	"github.com/bwmarrin/snowflake"
)

type Generator struct {
	node *snowflake.Node
}

// NewGenerator returns a self-contained Snowflake generator.
// Node ID is derived automatically from machine/container information.
func NewGenerator() (*Generator, error) {
	nodeID, err := deriveNodeID()
	if err != nil {
		return nil, fmt.Errorf("cannot derive node ID: %w", err)
	}

	node, err := snowflake.NewNode(nodeID)
	if err != nil {
		return nil, err
	}

	return &Generator{node: node}, nil
}

// deriveNodeID automatically generates a unique node ID (0–1023)
func deriveNodeID() (int64, error) {
	// 1️⃣ Try to use the MAC address if available
	interfaces, err := net.Interfaces()
	if err == nil {
		for _, i := range interfaces {
			if len(i.HardwareAddr) >= 6 {
				// Hash the MAC address
				h := fnv.New32a()
				_, _ = h.Write(i.HardwareAddr)
				return int64(h.Sum32() % 1024), nil
			}
		}
	}

	// 2️⃣ Fallback: use hostname hash
	hostname, err := os.Hostname()
	if err != nil {
		return 0, err
	}

	h := fnv.New32a()
	_, _ = h.Write([]byte(hostname))
	return int64(h.Sum32() % 1024), nil
}

// Generate returns the raw int64 ID
func (g *Generator) Generate() int64 {
	return g.node.Generate().Int64()
}

// GenerateString returns a Base36 encoded ID (shorter, URL-safe)
func (g *Generator) GenerateString() string {
	return g.node.Generate().Base36()
}

// GenerateWithPrefix returns ID with a prefix, e.g., "ATT-XXXXX"
func (g *Generator) GenerateWithPrefix(prefix string) string {
	return fmt.Sprintf("%s-%s", prefix, g.node.Generate().Base36())
}


// GenerateShort ret
//returns an int64 with at most 12 digits
func (g *Generator) GenerateShort() int64 {
	const max12Digits int64 = 1_000_000_000_000 // 10^12
	id := g.node.Generate().Int64()
	return id % max12Digits
}
