package common

import (
	"bytes"
	"encoding/json"
	"sync"

	"github.com/gofiber/fiber/v3"
)

var (
	// Increase initial capacity to 8KB to accommodate your 7.3KB payloads
	// without triggering a mid-request reallocation.
	bufferPool = sync.Pool{
		New: func() any {
			return bytes.NewBuffer(make([]byte, 0, 8192))
		},
	}
)

func SendJSON(c fiber.Ctx, status int, v any) error {
	c.Status(status)
	c.Set(fiber.HeaderContentType, fiber.MIMEApplicationJSON)

	buf := bufferPool.Get().(*bytes.Buffer)
	buf.Reset()
	// No defer here for extreme perf; put it back manually after write

	enc := json.NewEncoder(buf)
	enc.SetEscapeHTML(false)

	if err := enc.Encode(v); err != nil {
		bufferPool.Put(buf)
		return err
	}

	data := buf.Bytes()
	// Trim newline
	if len(data) > 0 && data[len(data)-1] == '\n' {
		data = data[:len(data)-1]
	}

	_, err := c.Write(data)
	bufferPool.Put(buf) // Put back after write
	return err
}

// Success sends a successful JSON response using the optimized pool
func Success(c fiber.Ctx, data any) error {
	return SendJSON(c, fiber.StatusOK, fiber.Map{
		"success": true,
		"data":    data,
	})
}

// Error sends an error JSON response
func Error(c fiber.Ctx, status int, message string) error {
	return SendJSON(c, status, fiber.Map{
		"success": false,
		"error":   message,
	})
}
