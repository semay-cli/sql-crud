package repository

import (
    "context"
    "os"
    "strconv"
    "testing"

    "{{ .ProjectName }}/{{ .AppName }}/models"
    "{{ .ProjectName }}/cache"
    "{{ .ProjectName }}/configs"
    "{{ .ProjectName }}/database"
    "{{ .ProjectName }}/logs"
)

func setup{{ .ParentName }}To{{ .FieldName }}TestRepo(t *testing.T) (*{{ .AppName | toPascalCase }}Repository, func()) {
    os.Setenv("{{ .AppName | replaceStringCapitalize }}_DB_TYPE", "sqlite")
    os.Setenv("{{ .AppName | replaceStringCapitalize }}_SQLLITE_URI", ":memory:")

    cfg, _ := configs.NewEnvConfig()
    logger := logs.NewZapLogger()

    bundle, err := database.ReturnSession("{{ .AppName | replaceString }}", cfg, logger)
    if err != nil {
        t.Fatalf("failed to connect to test db: %v", err)
    }

    if err := bundle.Gorm.AutoMigrate(&models.{{ .ParentName }}{}, &models.{{ .FieldName }}{}); err != nil {
        t.Fatalf("failed to migrate schema: %v", err)
    }

    cacheSvc, _ := cache.NewCacheService(cfg)
    repo := InitRepository(bundle, cacheSvc, cfg)

    cleanup := func() {
        os.Unsetenv("{{ .AppName | replaceStringCapitalize }}_DB_TYPE")
        os.Unsetenv("{{ .AppName | replaceStringCapitalize }}_SQLLITE_URI")
    }

    return repo, cleanup
}

func Test{{ .AppName | toPascalCase }}Repository_{{ .ParentName }}To{{ .FieldName }}_Relationship(t *testing.T) {
    repo, cleanup := setup{{ .ParentName }}To{{ .FieldName }}TestRepo(t)
    defer cleanup()

    ctx := context.Background()

    // 1️⃣ Create Parent
    parentPost := &models.{{ .ParentName }}Post{
        {{- range .ParentFields }}
        {{- if .Post }}
        {{- if eq .Type "string" }}
        {{ .Name }}: sPtr("{{ randomString }}"),
        {{- else if eq .Type "bool" }}
        {{ .Name }}: boolPtr({{ randomBool }}),
        {{- else if eq .Type "time.Time" }}
        {{ .Name }}: timePtr(parseTime("{{ randomTime }}")),
        {{- else if eq .Type "uint" }}
        {{ .Name }}: uintPtr({{ randomUInt }}),
        {{- else if eq .Type "uint64" }}
        {{ .Name }}: uint64Ptr({{ randomUInt }}),
        {{- else if eq .Type "int64" }}
        {{ .Name }}: int64Ptr({{ randomUInt }}),
        {{- else if eq .Type "float64" }}
        {{ .Name }}: float64Ptr({{ randomFloat }}),
        {{- else }}
        {{ .Name }}: nil, // fallback
        {{- end }}
        {{- end }}
        {{- end }}
    }
    parentObj := &models.{{ .ParentName }}{}
    if err := repo.Create{{ .ParentName }}(ctx, parentPost, nil, parentObj); err != nil {
        t.Fatalf("failed to create parent {{ .ParentName }}: %v", err)
    }

    // 2️⃣ Create Field / Child
    fieldPost := &models.{{ .FieldName }}Post{
        {{- range .ResponseModel.Fields }}
        {{- if .Post }}
        {{- if eq .Type "string" }}
        {{ .Name }}: sPtr("{{ randomString }}"),
        {{- else if eq .Type "bool" }}
        {{ .Name }}: boolPtr({{ randomBool }}),
        {{- else if eq .Type "time.Time" }}
        {{ .Name }}: timePtr(parseTime("{{ randomTime }}")),
        {{- else if .ForeignKeyModel }}
        {{- if eq .ForeignKeyModel $.ParentName }}
        {{ .Name }}: uint64Ptr(parentObj.ID),
        {{- else }}
        {{ .Name }}: uint64Ptr({{ .RandomFieldValue }}),
        {{- end }}
        {{- else if eq .Type "uint" }}
        {{ .Name }}: uintPtr({{ randomUInt }}),
        {{- else if eq .Type "uint64" }}
        {{ .Name }}: uint64Ptr({{ randomUInt }}),
        {{- else if eq .Type "int64" }}
        {{ .Name }}: int64Ptr({{ randomUInt }}),
        {{- else if eq .Type "float64" }}
        {{ .Name }}: float64Ptr({{ randomFloat }}),
        {{- else }}
        {{ .Name }}: nil,
        {{- end }}
        {{- end }}
        {{- end }}
    }
    fieldObj := &models.{{ .FieldName }}{}
    if err := repo.Create{{ .FieldName }}(ctx, fieldPost, nil, fieldObj); err != nil {
        t.Fatalf("failed to create field {{ .FieldName }}: %v", err)
    }

    pIDStr := strconv.Itoa(int(parentObj.ID))
    fIDStr := strconv.Itoa(int(fieldObj.ID))

    // 3️⃣ Add Relationship
    t.Run("AddRelationship", func(t *testing.T) {
        if err := repo.Add{{ .ParentName }}To{{ .FieldName }}(ctx, pIDStr, fIDStr, nil); err != nil {
            t.Fatalf("failed to add relationship: %v", err)
        }
    })

    // 4️⃣ Get Relationship
    t.Run("GetRelationships", func(t *testing.T) {
        var results []models.{{ .FieldName }}Get
        pagination := models.Pagination{Page: 1, Size: 10}
        total, err := repo.Get{{ .ParentName }}{{ .FieldName }}s(ctx, pIDStr, pagination, &results)
        if err != nil {
            t.Fatalf("failed to get relationships: %v", err)
        }
        if total == 0 {
            t.Errorf("expected >=1 relationship, got %d", total)
        }
    })

    // 5️⃣ Get Missing
    t.Run("GetMissingRelationships", func(t *testing.T) {
        var missing []models.{{ .FieldName }}Get
        if err := repo.GetAll{{ .FieldName }}s{{ .ParentName | toLowerCaseName }}DoesNotHave(ctx, pIDStr, &missing); err != nil {
            t.Fatalf("failed to get missing relationships: %v", err)
        }
    })

    // 6️⃣ Remove Relationship
    t.Run("RemoveRelationship", func(t *testing.T) {
        if err := repo.Remove{{ .ParentName }}From{{ .FieldName }}(ctx, pIDStr, fIDStr, nil); err != nil {
            t.Fatalf("failed to remove relationship: %v", err)
        }
    })
}